import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-048ebd6d.js";const p={},e=t(`<h1 id="订阅说明" tabindex="-1"><a class="header-anchor" href="#订阅说明" aria-hidden="true">#</a> 订阅说明</h1><h2 id="实现原理" tabindex="-1"><a class="header-anchor" href="#实现原理" aria-hidden="true">#</a> 实现原理</h2><p>使用ttrss.py启动订阅服务接口，使用rsshub订阅插件，将Tiny Tiny RSS地址改为订阅接口地址，即可直接订阅网站，存入rss.csv。</p><p>定时执行write2csv.py<span></span>，抓取网络上的订阅地址，存入rss.csv。</p><p>定时执行write2md.py<span></span>，读取rss.csv，获取今日新增文章，写入md文档，提交git，自动显示在每日悦读。</p><p>参考代码：</p><h2 id="ttrss-py" tabindex="-1"><a class="header-anchor" href="#ttrss-py" aria-hidden="true">#</a> ttrss.py<span></span></h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># coding: utf-8</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
@File    :   main.py
@Time    :   2023/05/05 18:46:35
@Author  :   lijc210@163.com
@Desc    :   模拟rsshub订阅插件，将Tiny Tiny RSS订阅到此地址
依赖模块 pip install fastapi,feedparser,uvicorn,requests
订阅请求地址 http://localhost:8000/public.php?op=bookmarklets--subscribe&amp;feed_url=https://rustcc.cn/rss
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> write2csv <span class="token keyword">import</span> write2csv

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

order<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y%m%d&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tomorrow <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">}</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/items/{item_id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> q<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;item_id&quot;</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">&quot;q&quot;</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/public.php&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">public</span><span class="token punctuation">(</span>op<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> feed_url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># print(op)</span>
        <span class="token comment"># print(feed_url)</span>
        success<span class="token punctuation">,</span> msg <span class="token operator">=</span> write2csv<span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">:</span> success<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> msg<span class="token punctuation">}</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token operator">=</span><span class="token string">&quot;ttrss:app&quot;</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token builtin">reload</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="write2md-py" tabindex="-1"><a class="header-anchor" href="#write2md-py" aria-hidden="true">#</a> write2md.py<span></span></h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># coding: utf-8</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
@File    :   main.py
@Time    :   2023/05/05 18:46:35
@Author  :   lijc210@163.com
@Desc    :   定时抓取所有订阅地址，获取今日新增文章，写入md文档，自动显示在每日悦读。
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> feedparser
<span class="token keyword">from</span> time <span class="token keyword">import</span> mktime
<span class="token keyword">from</span> concurrent <span class="token keyword">import</span> futures
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">from</span> http<span class="token punctuation">.</span>client <span class="token keyword">import</span> IncompleteRead
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> URLError
<span class="token keyword">from</span> utils <span class="token keyword">import</span> headers<span class="token punctuation">,</span> http<span class="token punctuation">,</span> https<span class="token punctuation">,</span> proxy_handler<span class="token punctuation">,</span> open_google<span class="token punctuation">,</span> send_text


<span class="token keyword">def</span> <span class="token function">dingyue2md</span><span class="token punctuation">(</span>sdate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dingyue_md <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;---
order: -2
icon: read
date: </span><span class="token interpolation"><span class="token punctuation">{</span>sdate<span class="token punctuation">}</span></span><span class="token string">
# timeline: false
article: false
category:
- 每日悦读
# tag:
#   - 红
#   - 大
#   - 圆
---
# 订阅列表
&quot;&quot;&quot;</span></span>
    ttrss_md <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    github_md <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        old_json <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        data_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>
    <span class="token keyword">if</span> data_list <span class="token operator">!=</span> old_json<span class="token punctuation">:</span>  <span class="token comment"># 有更新才提交</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;有新增订阅地址&quot;</span><span class="token punctuation">)</span>
        <span class="token comment"># 将所有订阅地址写入订阅列表.md</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;src/每日悦读/订阅列表.md&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fw<span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> rss<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> source <span class="token operator">=</span> line
                    title <span class="token operator">=</span> title<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\|&quot;</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                        ttrss_md <span class="token operator">+=</span> <span class="token string">&quot;## ttrss订阅\\n&quot;</span>
                        ttrss_md <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;|</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>rss<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>tags<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>source<span class="token punctuation">}</span></span><span class="token string">|\\n&quot;</span></span>
                        ttrss_md <span class="token operator">+=</span> <span class="token string">&quot;| :-----| :-----| :-----| :-----|\\n&quot;</span>
                        github_md <span class="token operator">+=</span> <span class="token string">&quot;## github订阅\\n&quot;</span>
                        github_md <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;|</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>rss<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>tags<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>source<span class="token punctuation">}</span></span><span class="token string">|\\n&quot;</span></span>
                        github_md <span class="token operator">+=</span> <span class="token string">&quot;| :-----| :-----| :-----| :-----|\\n&quot;</span>
                    <span class="token keyword">elif</span> source <span class="token operator">==</span> <span class="token string">&quot;ttrss&quot;</span><span class="token punctuation">:</span>
                        ttrss_md <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;|[</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">](</span><span class="token interpolation"><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span><span class="token string">)|[rss](</span><span class="token interpolation"><span class="token punctuation">{</span>rss<span class="token punctuation">}</span></span><span class="token string">)|</span><span class="token interpolation"><span class="token punctuation">{</span>tags<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>source<span class="token punctuation">}</span></span><span class="token string">|\\n&quot;</span></span>
                    <span class="token keyword">elif</span> source <span class="token operator">==</span> <span class="token string">&quot;github&quot;</span><span class="token punctuation">:</span>
                        github_md <span class="token operator">+=</span> <span class="token punctuation">(</span>
                            <span class="token string-interpolation"><span class="token string">f&quot;|[</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">](</span><span class="token interpolation"><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span><span class="token string">)|[rss](</span><span class="token interpolation"><span class="token punctuation">{</span>rss<span class="token punctuation">}</span></span><span class="token string">)|</span><span class="token interpolation"><span class="token punctuation">{</span>tags<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>source<span class="token punctuation">}</span></span><span class="token string">|\\n&quot;</span></span>
                        <span class="token punctuation">)</span>
                fw<span class="token punctuation">.</span>write<span class="token punctuation">(</span>dingyue_md <span class="token operator">+</span> ttrss_md <span class="token operator">+</span> github_md<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data_list<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;无新增订阅地址&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_updated_time</span><span class="token punctuation">(</span>feed_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;rss更新的时间&quot;&quot;&quot;</span>
    update_time_parsed <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> feed_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> time<span class="token punctuation">.</span>struct_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
            update_time_parsed <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>mktime<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> update_time_parsed


<span class="token keyword">def</span> <span class="token function">get_entry_updated_time</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;文章的发布时间&quot;&quot;&quot;</span>

    entry_published_parsed <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> entry<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> time<span class="token punctuation">.</span>struct_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                entry_published_parsed <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>mktime<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token string">&quot;year 0 is out of range&quot;</span> <span class="token keyword">in</span> msg <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
                    traceback<span class="token punctuation">.</span>print_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> entry_published_parsed


<span class="token keyword">def</span> <span class="token function">get_article</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    index<span class="token punctuation">,</span> feed_url<span class="token punctuation">,</span> feed_title<span class="token punctuation">,</span> sdate <span class="token operator">=</span> args
    start_date <span class="token operator">=</span> sdate
    end_date <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>sdate<span class="token punctuation">,</span> <span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
        <span class="token string">&quot;%Y-%m-%d&quot;</span>
    <span class="token punctuation">)</span>
    lines <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    feed_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        feed_dict <span class="token operator">=</span> feedparser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>
            feed_url<span class="token punctuation">,</span> request_headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> handlers<span class="token operator">=</span><span class="token punctuation">[</span>proxy_handler<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">except</span> IncompleteRead<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t0\\tIncompleteRead错误&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> URLError<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t0\\tURLError错误&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        msg <span class="token operator">=</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t0\\n</span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;tmp.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>feed_dict<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                    feed_dict<span class="token punctuation">[</span><span class="token string">&quot;bozo_exception&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>feed_dict<span class="token punctuation">[</span><span class="token string">&quot;bozo_exception&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>feed_dict<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        entries <span class="token operator">=</span> feed_dict<span class="token punctuation">[</span><span class="token string">&quot;entries&quot;</span><span class="token punctuation">]</span>
        feed <span class="token operator">=</span> feed_dict<span class="token punctuation">[</span><span class="token string">&quot;feed&quot;</span><span class="token punctuation">]</span>
        bozo_exception <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>feed_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;feed_dict&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">&quot;error&quot;</span> <span class="token keyword">in</span> bozo_exception<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t0\\t</span><span class="token interpolation"><span class="token punctuation">{</span>bozo_exception<span class="token punctuation">}</span></span><span class="token string">错误&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> entries <span class="token keyword">and</span> <span class="token keyword">not</span> feed<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\\t没有数据&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> feed_title<span class="token punctuation">,</span> lines
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        updated_time <span class="token operator">=</span> get_updated_time<span class="token punctuation">(</span>feed_dict<span class="token punctuation">)</span>
        <span class="token keyword">for</span> entry <span class="token keyword">in</span> entries<span class="token punctuation">:</span>
            <span class="token comment"># import json</span>
            <span class="token comment"># print(json.dumps(entry,ensure_ascii=False))</span>
            <span class="token comment"># print(entry[&quot;summary&quot;])</span>
            title <span class="token operator">=</span> entry<span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span>
            title <span class="token operator">=</span> title<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\[&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\]&quot;</span><span class="token punctuation">)</span>
            link <span class="token operator">=</span> entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;link&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> link<span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>
                    <span class="token string">&quot;{index}\\t{feed_url}\\t{feed_title}\\t{len(entries)}\\tlink不存在&quot;</span>
                <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                entry_updated_time <span class="token operator">=</span> get_entry_updated_time<span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
                <span class="token comment"># if not entry_updated_time:</span>
                <span class="token comment">#     entry_updated_time = updated_time</span>
                <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
                    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                        <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_url<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>link<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>updated_time<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>entry_updated_time<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
                    <span class="token punctuation">)</span>
                <span class="token keyword">if</span> start_date <span class="token operator">&lt;=</span> entry_updated_time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> end_date<span class="token punctuation">:</span>
                    published_time <span class="token operator">=</span> entry_updated_time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%H:%M:%S&quot;</span><span class="token punctuation">)</span>
                    lines<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;* [</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">](</span><span class="token interpolation"><span class="token punctuation">{</span>link<span class="token punctuation">}</span></span><span class="token string">) *</span><span class="token interpolation"><span class="token punctuation">{</span>published_time<span class="token punctuation">}</span></span><span class="token string">* \\n&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> feed_title<span class="token punctuation">,</span> lines


<span class="token keyword">def</span> <span class="token function">write2md</span><span class="token punctuation">(</span>sdate<span class="token punctuation">,</span> top<span class="token punctuation">,</span> workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    order<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y%m%d&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>sdate<span class="token punctuation">,</span> <span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    yuedu_md <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;---
order: -</span><span class="token interpolation"><span class="token punctuation">{</span>order<span class="token punctuation">}</span></span><span class="token string">
icon: read
date: </span><span class="token interpolation"><span class="token punctuation">{</span>sdate<span class="token punctuation">}</span></span><span class="token string">
# timeline: false
article: false
category:
- 每日悦读
# tag:
#   - 红
#   - 大
#   - 圆
---

# </span><span class="token interpolation"><span class="token punctuation">{</span>sdate<span class="token punctuation">}</span></span><span class="token string"> 
&quot;&quot;&quot;</span></span>
    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> open_google<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        <span class="token comment"># 遍历读取订阅地址，获取当日更新，写入每日悦读.md</span>
        data_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
        args_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                feed_title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> feed_url<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> source <span class="token operator">=</span> line
                <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> i <span class="token operator">&gt;</span> top<span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                <span class="token comment"># if &quot;coolshell&quot; not in feed_url:</span>
                <span class="token comment">#     continue</span>
                args_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> feed_url<span class="token punctuation">,</span> feed_title<span class="token punctuation">,</span> sdate<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> workers <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> <span class="token punctuation">[</span>get_article<span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token keyword">for</span> args <span class="token keyword">in</span> args_list<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>workers<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
                res <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>get_article<span class="token punctuation">,</span> args_list<span class="token punctuation">)</span>

        <span class="token keyword">for</span> r <span class="token keyword">in</span> res<span class="token punctuation">:</span>
            feed_title<span class="token punctuation">,</span> lines <span class="token operator">=</span> r
            <span class="token keyword">if</span> lines<span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;今日新增\\t</span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
                aline <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;## </span><span class="token interpolation"><span class="token punctuation">{</span>feed_title<span class="token punctuation">}</span></span><span class="token string">&lt;span&gt;&lt;/span&gt;\\n&quot;</span></span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
                    aline <span class="token operator">+=</span> line
                yuedu_md <span class="token operator">+=</span> aline
                data_dict<span class="token punctuation">[</span>feed_title<span class="token punctuation">]</span><span class="token punctuation">.</span>extend<span class="token punctuation">(</span>lines<span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;data_dict.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            old_json <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> data_dict <span class="token operator">!=</span> old_json<span class="token punctuation">:</span>  <span class="token comment"># 有更新才提交</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;有内容更新&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;data_dict.json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data_dict<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;src/每日悦读/</span><span class="token interpolation"><span class="token punctuation">{</span>sdate<span class="token punctuation">}</span></span><span class="token string">.md&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>yuedu_md<span class="token punctuation">)</span>

            <span class="token comment"># 提交git</span>
            <span class="token comment"># os.system(f&quot;git config http.proxy {http}&quot;)</span>
            <span class="token comment"># os.system(f&quot;git config https.proxy {https}&quot;)</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;git pull &amp;&amp; git add . &amp;&amp; git commit -m &#39;rss&#39; &amp;&amp; git push&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;无内容更新&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> args<span class="token punctuation">:</span>
            sdate <span class="token operator">=</span> args
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            sdate<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;日期：&quot;</span><span class="token punctuation">,</span> sdate<span class="token punctuation">)</span>
        dingyue2md<span class="token punctuation">(</span>sdate<span class="token punctuation">)</span>  <span class="token comment"># 将所有订阅地址写入订阅说明.md</span>
        write2md<span class="token punctuation">(</span>sdate<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> workers<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        send_text<span class="token punctuation">(</span><span class="token string">&quot;write2md.py执行失败&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sdate<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> get_article<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> feed_url<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> sdate<span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> sys

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        args <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">:</span>
            <span class="token comment"># args = &quot;2023-06-14&quot;</span>
            run<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            test<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="write2csv-py" tabindex="-1"><a class="header-anchor" href="#write2csv-py" aria-hidden="true">#</a> write2csv.py<span></span></h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># coding: utf-8</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
@File    :   main.py
@Time    :   2023/05/05 18:46:35
@Author  :   lijc210@163.com
@Desc    :   将rss地址写入rss.csv
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> feedparser
<span class="token keyword">import</span> time
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> tempfile <span class="token keyword">import</span> NamedTemporaryFile
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> build_opener<span class="token punctuation">,</span> Request
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse
<span class="token keyword">from</span> utils <span class="token keyword">import</span> headers<span class="token punctuation">,</span> http<span class="token punctuation">,</span> https<span class="token punctuation">,</span> proxy_handler<span class="token punctuation">,</span> open_google<span class="token punctuation">,</span> send_text


<span class="token keyword">def</span> <span class="token function">write2csv</span><span class="token punctuation">(</span>feed_url<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> open_google<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        feed <span class="token operator">=</span> feedparser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>
            feed_url<span class="token punctuation">,</span> request_headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> handlers<span class="token operator">=</span><span class="token punctuation">[</span>proxy_handler<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># import pprint</span>
        <span class="token comment"># pprint.pprint(feed, depth=2)</span>
        bozo_exception <span class="token operator">=</span> feed<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;bozo_exception&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> bozo_exception<span class="token punctuation">:</span>
            success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>bozo_exception<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            feed_title <span class="token operator">=</span> feed<span class="token punctuation">[</span><span class="token string">&quot;feed&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> feed_title<span class="token punctuation">:</span>
                success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&quot;地址无效&quot;</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                rss_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                    <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token comment"># print(line)</span>
                        <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                            title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> rss<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> source <span class="token operator">=</span> line
                            rss_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>rss<span class="token punctuation">)</span>

                <span class="token keyword">if</span> feed_url <span class="token keyword">in</span> rss_set<span class="token punctuation">:</span>
                    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&quot;已订阅过&quot;</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># 保存</span>
                    url <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span><span class="token punctuation">.</span>scheme <span class="token operator">+</span> <span class="token string">&quot;://&quot;</span> <span class="token operator">+</span> urlparse<span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span><span class="token punctuation">.</span>netloc
                    alist <span class="token operator">=</span> <span class="token punctuation">[</span>feed_title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> feed_url<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ttrss&quot;</span><span class="token punctuation">]</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> csvfile<span class="token punctuation">:</span>
                        spamwriter <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>csvfile<span class="token punctuation">)</span>
                        spamwriter<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>alist<span class="token punctuation">)</span>
                    <span class="token comment"># sdate: str = time.strftime(&quot;%Y-%m-%d&quot;, time.localtime(time.time()))</span>
                    <span class="token comment"># dingyue2md(sdate)  # 将所有订阅地址写入订阅说明.md</span>
                    <span class="token comment"># write2md(sdate, 2000)</span>
                    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&quot;订阅成功&quot;</span>

                <span class="token comment"># 提交git</span>
                <span class="token comment"># os.system(f&quot;git config http.proxy {http}&quot;)</span>
                <span class="token comment"># os.system(f&quot;git config https.proxy {https}&quot;)</span>
                os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;git pull &amp;&amp; git add . &amp;&amp; git commit -m &#39;rss&#39; &amp;&amp; git push&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> success<span class="token punctuation">,</span> msg


<span class="token keyword">def</span> <span class="token function">download2csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://raw.githubusercontent.com/timqian/chinese-independent-blogs/master/blogs-original.csv&quot;</span>
    opener <span class="token operator">=</span> build_opener<span class="token punctuation">(</span>proxy_handler<span class="token punctuation">)</span>
    request <span class="token operator">=</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    r <span class="token operator">=</span> opener<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>

    rss_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># print(line)</span>
            <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> rss<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> source <span class="token operator">=</span> line
                rss_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>rss<span class="token punctuation">)</span>

    <span class="token keyword">with</span> NamedTemporaryFile<span class="token punctuation">(</span>suffix<span class="token operator">=</span><span class="token string">&quot;blogs-original.csv&quot;</span><span class="token punctuation">,</span> delete<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ntf<span class="token punctuation">:</span>
        ntf<span class="token punctuation">.</span>write<span class="token punctuation">(</span>r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        date_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>ntf<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># print(line)</span>
                <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token comment"># print(line)</span>
                    title <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                    url <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                    rss <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                    tags <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                    alist <span class="token operator">=</span> <span class="token punctuation">[</span>title<span class="token punctuation">,</span> url<span class="token punctuation">,</span> rss<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> <span class="token string">&quot;github&quot;</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> rss <span class="token keyword">not</span> <span class="token keyword">in</span> rss_set<span class="token punctuation">:</span>
                        date_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>alist<span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;rss.csv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> csvfile<span class="token punctuation">:</span>
        spamwriter <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>csvfile<span class="token punctuation">)</span>
        spamwriter<span class="token punctuation">.</span>writerows<span class="token punctuation">(</span>date_list<span class="token punctuation">)</span>
        <span class="token comment"># for row in date_list:</span>
        <span class="token comment">#     spamwriter.writerow(row)</span>

    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;新增</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>date_list<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">条rss&quot;</span></span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        download2csv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        send_text<span class="token punctuation">(</span><span class="token string">&quot;write2md.py执行失败&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    success<span class="token punctuation">,</span> msg <span class="token operator">=</span> write2csv<span class="token punctuation">(</span>feed_url<span class="token operator">=</span>feed_url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> sys

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        feed_url <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        test<span class="token punctuation">(</span>feed_url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="utils-py" tabindex="-1"><a class="header-anchor" href="#utils-py" aria-hidden="true">#</a> utils.py<span></span></h2><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># coding: utf-8</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
@File    :   utils.py
@Time    :   2023/06/16 17:37:32
@Author  :   lijc210@163.com
@Desc    :   None
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> ssl
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlencode
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> ProxyHandler

socket<span class="token punctuation">.</span>setdefaulttimeout<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token comment"># 日志输出</span>
fh <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">&quot;rss.log&quot;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 用于输出到文件</span>
hdr <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 用于输出到控制台</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>  <span class="token comment"># 控制台打印的日志级别</span>
    handlers<span class="token operator">=</span><span class="token punctuation">[</span>fh<span class="token punctuation">,</span> hdr<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">&quot;[%(asctime)s] %(levelname)s %(filename)s[%(lineno)d]: %(message)s&quot;</span>
    <span class="token comment"># 日志格式</span>
<span class="token punctuation">)</span>

<span class="token comment"># certificate verify failed 报错</span>
<span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> <span class="token string">&quot;_create_unverified_context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ssl<span class="token punctuation">.</span>_create_default_https_context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>_create_unverified_context


<span class="token keyword">if</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;SHBGDZ05373&quot;</span><span class="token punctuation">:</span>
    http<span class="token punctuation">,</span> https <span class="token operator">=</span> <span class="token string">&quot;http://172.17.15.93:7890&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://172.17.15.93:7890&quot;</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    http<span class="token punctuation">,</span> https <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:7890&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:7890&quot;</span>

proxies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">:</span> http<span class="token punctuation">,</span> <span class="token string">&quot;https&quot;</span><span class="token punctuation">:</span> https<span class="token punctuation">}</span>
proxy_handler <span class="token operator">=</span> ProxyHandler<span class="token punctuation">(</span>proxies<span class="token punctuation">)</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment"># &quot;Accept&quot;: &quot;application/json, text/javascript, */*; q=0.01&quot;,</span>
    <span class="token string">&quot;Accept-Encoding&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gzip, deflate, br&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Accept-Language&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Connection&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Sec-Ch-Ua-Platform&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Windows&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

ftqq <span class="token operator">=</span> <span class="token string">&quot;xxxxxxxxxxxxxxxxxxx&quot;</span>
key <span class="token operator">=</span> <span class="token string">&quot;xxxxxxxxxxxxxxxxxxx&quot;</span>


<span class="token keyword">def</span> <span class="token function">send_text</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 通知到微信</span>
    wd <span class="token operator">=</span> urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">:</span> msg<span class="token punctuation">,</span> <span class="token string">&quot;desp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># https://sct.ftqq.com/</span>
        req <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f&quot;https://sctapi.ftqq.com/</span><span class="token interpolation"><span class="token punctuation">{</span>ftqq<span class="token punctuation">}</span></span><span class="token string">.send?</span><span class="token interpolation"><span class="token punctuation">{</span>wd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>req<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> req<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">40001</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;条数限制&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;条数限制&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token comment"># 通知到企业微信</span>
        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;msgtype&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> msg<span class="token punctuation">,</span>
                <span class="token string">&quot;mentioned_list&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> json<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>req<span class="token punctuation">.</span>text<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">open_google</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        req <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
            <span class="token string">&quot;https://www.google.com/&quot;</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers
        <span class="token punctuation">)</span>
        success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&quot;访问成功&quot;</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;write2md不能访问谷歌&quot;</span><span class="token punctuation">)</span>
        <span class="token comment"># print(traceback.format_exc())</span>
        success<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&quot;write2md不能访问谷歌&quot;</span>
        send_text<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> success<span class="token punctuation">,</span> msg


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    open_google<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># send_text(&quot;test&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),o=[e];function c(i,l){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","订阅说明.html.vue"]]);export{k as default};

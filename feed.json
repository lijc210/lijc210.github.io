{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "此在笔记",
  "home_page_url": "https://blog.cizai.io/",
  "feed_url": "https://blog.cizai.io/feed.json",
  "description": "开源工具、效率方法、心理学探索的自我提升笔记 ，记录并输出一切能让自己提升的知识。",
  "items": [
    {
      "title": "流量捕获",
      "url": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7.html",
      "id": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7.html",
      "summary": "流量捕获 mitmproxy",
      "content_html": "\n<h2>mitmproxy</h2>\n",
      "date_published": "2024-06-11T00:00:00.000Z",
      "date_modified": "2024-06-11T09:57:48.000Z",
      "authors": [],
      "tags": [
        "工具"
      ]
    },
    {
      "title": "反向代理应用frp",
      "url": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/frp.html",
      "id": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/frp.html",
      "summary": "反向代理应用frp 拥有公网IP的情况下，可以使用frp来实现内网机器的端口映射和访问。 安装 linux mac 通过tcp访问内网机器端口 通过自定义域名访问内网的 Web 服务 代理上网 （无法打开被强的网站）",
      "content_html": "\n<p>拥有公网IP的情况下，可以使用frp来实现内网机器的端口映射和访问。</p>\n<h2>安装</h2>\n<p>linux</p>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>wget https://github.com/fatedier/frp/releases/download/v0.57.0/frp_0.57.0_linux_amd64.tar.gz\ntar -zxvf frp_0.57.0_linux_amd64.tar.gz\n</code></pre></div><p>mac</p>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>wget https://github.com/fatedier/frp/releases/download/v0.57.0/frp_0.57.0_darwin_arm64.tar.gz\ntar -zxvf frp_0.57.0_darwin_arm64.tar.gz\n</code></pre></div><h2>通过tcp访问内网机器端口</h2>\n<div class=\"language-bash\" data-ext=\"sh\" data-title=\"sh\"><pre class=\"language-bash\"><code>公网服务器上编辑frps.toml\nbindPort <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n内网服务器上编辑frpc.toml\nserverAddr <span class=\"token operator\">=</span> <span class=\"token string\">\"x.x.x.x\"</span> <span class=\"token comment\"># 公网服务器的 IP 地址</span>\nserverPort <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>proxies<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"ssh\"</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp\"</span>\nlocalIP <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>\nlocalPort <span class=\"token operator\">=</span> <span class=\"token number\">22</span>\nremotePort <span class=\"token operator\">=</span> <span class=\"token number\">2222</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>proxies<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"web\"</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp\"</span>\nlocalIP <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>\nlocalPort <span class=\"token operator\">=</span> <span class=\"token number\">5500</span>\nremotePort <span class=\"token operator\">=</span> <span class=\"token number\">5555</span>\n\n<span class=\"token comment\"># localIP 和 localPort 配置为需要从公网访问的内网服务的地址和端口。</span>\n<span class=\"token comment\"># remotePort 表示在 frp 服务端监听的端口，访问此端口的流量将被转发到本地服务的相应端口。</span>\n\n启动 frps 和 frpc\n./frps <span class=\"token parameter variable\">-c</span> frps.toml\n./frpc <span class=\"token parameter variable\">-c</span> frpc.toml\n\n使用以下命令通过 SSH 访问内网机器，假设用户名为 test：\n<span class=\"token function\">ssh</span> <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">Port</span><span class=\"token operator\">=</span><span class=\"token number\">2222</span> test@x.x.x.x\n\n使用以下命令通过 Web 服务访问内网机器，假设服务运行在 <span class=\"token number\">5555</span> 端口：\n<span class=\"token function\">curl</span> http://x.x.x.x:5555\n\n</code></pre></div><h2>通过自定义域名访问内网的 Web 服务</h2>\n<div class=\"language-bash\" data-ext=\"sh\" data-title=\"sh\"><pre class=\"language-bash\"><code>公网服务器上编辑frps.toml\nbindPort <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n内网服务器上编辑frpc.toml\nserverAddr <span class=\"token operator\">=</span> <span class=\"token string\">\"x.x.x.x\"</span> <span class=\"token comment\"># 公网服务器的 IP 地址</span>\nserverPort <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>proxies<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"web\"</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http\"</span>\nlocalIP <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>\nlocalPort <span class=\"token operator\">=</span> <span class=\"token number\">80</span>\ncustomDomains <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"www.yourdomain.com\"</span><span class=\"token punctuation\">]</span>\n\n启动 frps 和 frpc\n./frps <span class=\"token parameter variable\">-c</span> frps.toml\n./frpc <span class=\"token parameter variable\">-c</span> frpc.toml\n\n将 www.yourdomain.com的域名 A 记录解析到服务器的 IP 地址 x.x.x.x\n\n访问 http://www.yourdomain.com 即可访问内网的 Web 服务\n</code></pre></div><h2>代理上网 （无法打开被强的网站）</h2>\n<div class=\"language-bash\" data-ext=\"sh\" data-title=\"sh\"><pre class=\"language-bash\"><code>公网服务器上编辑frps.toml\nbindPort <span class=\"token operator\">=</span> <span class=\"token number\">7000</span>\n\n内网服务器上编辑frpc.toml\nserverAddr <span class=\"token operator\">=</span> <span class=\"token string\">\"x.x.x.x\"</span> <span class=\"token comment\"># 公网服务器的 IP 地址</span>\nserver_port <span class=\"token operator\">=</span> <span class=\"token number\">7000</span> \n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>proxies<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"plugin_http_proxy\"</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp\"</span>\nremotePort <span class=\"token operator\">=</span> <span class=\"token number\">6004</span>\n<span class=\"token punctuation\">[</span>proxies.plugin<span class=\"token punctuation\">]</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http_proxy\"</span>\nhttpUser <span class=\"token operator\">=</span> <span class=\"token string\">\"abc\"</span>\nhttpPassword <span class=\"token operator\">=</span> <span class=\"token string\">\"abc\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>proxies<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"plugin_socks5\"</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp\"</span>\nremotePort <span class=\"token operator\">=</span> <span class=\"token number\">6005</span>\n<span class=\"token punctuation\">[</span>proxies.plugin<span class=\"token punctuation\">]</span>\n<span class=\"token builtin class-name\">type</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"socks5\"</span>\nusername <span class=\"token operator\">=</span> <span class=\"token string\">\"abc\"</span>\npassword <span class=\"token operator\">=</span> <span class=\"token string\">\"abc\"</span>\n\n启动 frps 和 frpc\n./frps <span class=\"token parameter variable\">-c</span> frps.toml\n./frpc <span class=\"token parameter variable\">-c</span> frpc.toml\n\n<span class=\"token comment\"># 设置代理</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">http_proxy</span><span class=\"token operator\">=</span>http://abc:abc@x.x.x.x:6004\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">https_proxy</span><span class=\"token operator\">=</span><span class=\"token variable\">$http_proxy</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">all_proxy</span><span class=\"token operator\">=</span>socks5://abc:abc@x.x.x.x:6005\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">no_proxy</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost,127.0.0.1,x.x.x.x\"</span>\n\n<span class=\"token function\">wget</span> https://www.baidu.com 可以代理访问\n<span class=\"token function\">wget</span> https://www.google.com 无法打开被强的网站，因为没有伪装加密\n\n</code></pre></div>",
      "date_published": "2024-04-02T00:00:00.000Z",
      "date_modified": "2024-04-28T11:22:56.000Z",
      "authors": [],
      "tags": [
        "工具"
      ]
    },
    {
      "title": "内网穿透",
      "url": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html",
      "id": "https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html",
      "summary": "内网穿透 serveo ssh -R 80:localhost:3000 serveo.net ngrok 启动时需要验证 ngrok http 3000 localtunnel 访问时需要验证 cloudflare tunnel vscode 端口转发 WireGuard frp https://github.com/fatedier/frp 免费域...",
      "content_html": "\n<h2>serveo</h2>\n<p>ssh -R 80:localhost:3000 serveo.net</p>\n<h2>ngrok</h2>\n<h3>启动时需要验证</h3>\n<p>ngrok http 3000</p>\n<h2>localtunnel</h2>\n<h3>访问时需要验证</h3>\n<div class=\"language-bash\" data-ext=\"sh\" data-title=\"sh\"><pre class=\"language-bash\"><code>快速开始\nnpx localtunnel <span class=\"token parameter variable\">--subdomain</span> cizai <span class=\"token parameter variable\">--port</span> <span class=\"token number\">3000</span>\n\n全局安装\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> localtunnel\nlt <span class=\"token parameter variable\">--port</span> <span class=\"token number\">3000</span>\n\n自定义个性前缀\nlt <span class=\"token parameter variable\">--subdomain</span> <span class=\"token operator\">&lt;</span>个性前缀<span class=\"token operator\">&gt;</span> <span class=\"token parameter variable\">--port</span> <span class=\"token operator\">&lt;</span>要映射的端口<span class=\"token operator\">&gt;</span>\n\n<span class=\"token comment\"># 获取访问密码</span>\n<span class=\"token function\">wget</span> <span class=\"token parameter variable\">-q</span> <span class=\"token parameter variable\">-O</span> - https://loca.lt/mytunnelpassword\n\n</code></pre></div><h2>cloudflare tunnel</h2>\n<div class=\"language-bash\" data-ext=\"sh\" data-title=\"sh\"><pre class=\"language-bash\"><code>\n登录到cloudflare.com，点击Zero Trust,  \n选择Network -<span class=\"token operator\">&gt;</span> Tunnels，点击Create a Tunnel，Cloudflared和WARP选择Cloudflared，填入一个tunnel名称\n点击保存后，选择 <span class=\"token function\">docker</span> 方式部署，在本地执行以下命令\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--name</span> cloudflared <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>unless-stopped cloudflare/cloudflared:latest tunnel --no-autoupdate run <span class=\"token parameter variable\">--token</span> <span class=\"token operator\">&lt;</span>token<span class=\"token operator\">&gt;</span> \n查看Connectors页面是否有刚才创建的Tunnel，接着点击下一步，填入子域名和要映射的本地端口，点击创建Tunnel，等待几分钟后，就可以通过子域名访问本地\n</code></pre></div><h2>vscode 端口转发</h2>\n<h2>WireGuard</h2>\n<h2>frp</h2>\n<p>https://github.com/fatedier/frp</p>\n<h2>免费域名</h2>\n<p>https://iyideng.net/welfare/best-free-domain-name-registration-platform.html</p>\n",
      "date_published": "2024-04-02T00:00:00.000Z",
      "date_modified": "2024-06-05T03:51:29.000Z",
      "authors": [],
      "tags": [
        "工具"
      ]
    },
    {
      "title": "关于本站",
      "url": "https://blog.cizai.io/%E5%85%B3%E4%BA%8E%E6%9C%AC%E7%AB%99.html",
      "id": "https://blog.cizai.io/%E5%85%B3%E4%BA%8E%E6%9C%AC%E7%AB%99.html",
      "summary": "关于本站 一个全栈开发者，从事大数据开发。 本站桌面端安装包，支持windows，linux，mac。下载地址 Loading...",
      "content_html": "\n<p>一个全栈开发者，从事大数据开发。</p>\n<p>本站桌面端安装包，支持windows，linux，mac。<a href=\"https://file.cizai.io/wooapp.json\" target=\"_blank\" rel=\"noopener noreferrer\">下载地址</a></p>\n<div id=\"dynamic-content\">\n  <p>Loading...</p>\n</div>\n",
      "image": "https://blog.cizai.io/assets/images/cover3.jpg",
      "date_published": "2024-03-17T17:45:45.000Z",
      "date_modified": "2024-05-17T11:26:17.000Z",
      "authors": [],
      "tags": []
    },
    {
      "title": "站点收藏",
      "url": "https://blog.cizai.io/%E7%AB%99%E7%82%B9%E6%94%B6%E8%97%8F.html",
      "id": "https://blog.cizai.io/%E7%AB%99%E7%82%B9%E6%94%B6%E8%97%8F.html",
      "summary": "站点收藏 白噪音 独立博客列表",
      "content_html": "\n<h2>白噪音</h2>\n<p>| 简介   | 网址                      |\n| :</p>\n",
      "date_published": "2022-01-01T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "站点收藏"
      ]
    },
    {
      "title": "订阅说明",
      "url": "https://blog.cizai.io/%E6%AF%8F%E6%97%A5%E6%82%A6%E8%AF%BB/",
      "id": "https://blog.cizai.io/%E6%AF%8F%E6%97%A5%E6%82%A6%E8%AF%BB/",
      "summary": "订阅说明 实现原理 使用ttrss.py启动订阅服务接口，使用rsshub订阅插件，将Tiny Tiny RSS地址改为订阅接口地址，即可直接订阅网站，存入rss.csv。 定时执行write2csv.py，抓取网络上的订阅地址，存入rss.csv。 定时执行write2md.py，读取rss.csv，获取今日新增文章，写入md文档，提交git，自动显...",
      "content_html": "\n<h2>实现原理</h2>\n<p>使用ttrss.py启动订阅服务接口，使用rsshub订阅插件，将Tiny Tiny RSS地址改为订阅接口地址，即可直接订阅网站，存入rss.csv。</p>\n<p>定时执行write2csv.py<span></span>，抓取网络上的订阅地址，存入rss.csv。</p>\n<p>定时执行write2md.py<span></span>，读取rss.csv，获取今日新增文章，写入md文档，提交git，自动显示在每日悦读。</p>\n<p>参考代码：\nhttps://github.com/lijc210/lijc210.github.io/blob/main/write2md.py</p>\n",
      "date_published": "2023-06-15T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "每日悦读"
      ]
    },
    {
      "title": "订阅说明",
      "url": "https://blog.cizai.io/%E6%AF%8F%E6%97%A5%E6%82%A6%E8%AF%BB/%E8%AE%A2%E9%98%85%E8%AF%B4%E6%98%8E.html",
      "id": "https://blog.cizai.io/%E6%AF%8F%E6%97%A5%E6%82%A6%E8%AF%BB/%E8%AE%A2%E9%98%85%E8%AF%B4%E6%98%8E.html",
      "summary": "订阅说明 实现原理 使用ttrss.py启动订阅服务接口，使用rsshub订阅插件，将Tiny Tiny RSS地址改为订阅接口地址，即可直接订阅网站，存入rss.csv。 定时执行write2csv.py，抓取网络上的订阅地址，存入rss.csv。 定时执行write2md.py，读取rss.csv，获取今日新增文章，写入md文档，提交git，自动显...",
      "content_html": "\n<h2>实现原理</h2>\n<p>使用ttrss.py启动订阅服务接口，使用rsshub订阅插件，将Tiny Tiny RSS地址改为订阅接口地址，即可直接订阅网站，存入rss.csv。</p>\n<p>定时执行write2csv.py<span></span>，抓取网络上的订阅地址，存入rss.csv。</p>\n<p>定时执行write2md.py<span></span>，读取rss.csv，获取今日新增文章，写入md文档，提交git，自动显示在每日悦读。</p>\n<p>参考代码：\nhttps://github.com/lijc210/lijc210.github.io/blob/main/write2md.py</p>\n",
      "date_published": "2023-06-15T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "每日悦读"
      ]
    },
    {
      "title": "Impala",
      "url": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/Impala.html",
      "id": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/Impala.html",
      "summary": "Impala Impala时间戳分组",
      "content_html": "\n<h2>Impala时间戳分组</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>select   \nfrom_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') as sdate,\ncount(1),\ncount(if(second_id is null,1,null))\nfrom users \n-- 2023-06-14 00:00:00\nwhere siyu_add_time &gt; 1686672000000\ngroup by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd')\norder by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') desc\n</code></pre></div>",
      "date_published": "2022-01-01T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "数据库"
      ]
    },
    {
      "title": "clickhouse",
      "url": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/clickhouse.html",
      "id": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/clickhouse.html",
      "summary": "clickhouse clickhouse 常用命令 clickhouse表引擎 clickhouse性能优化 数据类型 建表时能用数值型或日期时间型表示的字段，就不要用字符串——全String类型在以Hive为中心的数仓建设中常见，但CK环境不应受此影响。 虽然clickhouse底层将DateTime存储为时间戳Long类型，但不建议直接存储Lon...",
      "content_html": "\n<h2>clickhouse 常用命令</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>更新数据\nALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update item_no='' where item_no is null;\nALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update store_shop_code='' where store_shop_code is null;\nALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update unify_goods_code='' where unify_goods_code is null;\n\n\n重命名表\nRENAME TABLE table_A TO table_A_bak, table_B TO table_B_bak;\n\n\n\n查看所有表\nselect *\nFROM system.tables t WHERE database ='ads' AND engine &lt;&gt;'Distributed' ORDER by total_rows DESC \n\n\nselect *\nFROM system.tables t WHERE database ='ads'\nAND engine &lt;&gt;'Distributed'\nand name not like '%del%'\nand name not like '%20%'\nORDER by total_rows DESC\n\n\n\n自动清理query_log，query_thread_log，trace_log\n\nALTER TABLE system.query_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY\n\nALTER TABLE system.query_thread_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY\n\nALTER TABLE system.trace_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY\n\n立即清理\nalter table system.query_thread_log_0 drop partition '202105'\n分区名可以用下语句查询\nselect * from system.parts p where table = '表名'\n\n查看parts  \nselect * from system.parts  where table = 'abs_activity_item_info_day_replica'\nselect * from system.parts where active = 0\n当前慢查询\nSELECT * FROM system.processes limit 100\n\n耗时大于60秒\nkill query where elapsed &gt;= 60\n\nclickhouse不能创建等执行操作时（每个节点都要执行）\nselect * from system.mutations where is_done = 0;\nkill mutation ON CLUSTER ck_cluster1 \n where database='ads' and table='ads_jd_erp_sale_outstock_replica' \n\n\n进入zk清理任务\ndeleteall /clickhouse/distributed_ddl/query-0000011932\n查询阻塞的任务\nselect * from system.distributed_ddl_queue where status != 'Finished'\n\n\n查看表大小\nSELECT\n    table AS `表名`,\n    sum(rows) AS `总行数`,\n    formatReadableSize(sum(data_uncompressed_bytes)) AS `原始大小`,\n    formatReadableSize(sum(data_compressed_bytes)) AS `压缩大小`,\n    round((sum(data_compressed_bytes) / sum(data_uncompressed_bytes)) * 100, 0) AS `压缩率`\nFROM system.parts\nGROUP BY table\norder by sum(data_compressed_bytes) desc\n\n\n修改字段名\nALTER TABLE visits RENAME COLUMN webBrowser TO browser\n分布式集群下用分布式DDL修改字段名\nALTER TABLE visits on cluster shipin_cluster RENAME COLUMN webBrowser TO browser\n\n\n新增字段\n alter table ads_itemprice_sales_section_replica ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)\n alter table ads_itemprice_sales_section ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)\n</code></pre></div><h2>clickhouse表引擎</h2>\n<p>| 系列        | 引擎                         | 特点                                                                                                                                                                                                                                    | 场景                                                                                     |\n|</p>\n",
      "date_published": "2022-01-01T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "数据库"
      ]
    },
    {
      "title": "elasticsearch",
      "url": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch.html",
      "id": "https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch.html",
      "summary": "elasticsearch 查看集群状态，修复 记录慢日志，重启也生效 记录慢查询日志 批量按条件更新 搜索词分权重 统一更改刷新时间 优化性能 索引复制数据 暂时移除一个节点 搜索结果返回不一致问题 一、背景 这周在使用Elasticsearch搜索的时候遇到一个，对于同一个搜索请求，会出现top50返回结果和排序不一致的问题。那么为什么会出现这样的...",
      "content_html": "\n<h2>查看集群状态，修复</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>GET _cluster/allocation/explain?pretty\n\nGET /_cluster/allocation/explain\n\nget /_cluster/settings\n\nPUT /_cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.enable\": \"none\"\n  }\n}\n#分片配置\n\nPUT /_cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.enable\": \"all\"\n  }\n}\n\n#分片重新均衡分配\n\nPUT /_cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.rebalance.enable\": \"all\"\n  }\n}\n\n# 设置副本数量\nPUT /aabb/_settings\n{\n\"number_of_replicas\" : 2\n}\n\nget _cluster/health?level=indices\n\n\nGET _cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m\n\ncurl http://localhost:9200/_cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m\n\nget _cat/master\n\npost /_cluster/reroute\n{\n  \"commands\": [\n    {\n      \"allocate_empty_primary\": {\n        \"index\": \"wap_yonghu_v1\",\n        \"shard\": 2,\n        \"node\": \"Ee6ubnnmT52LJchcw0P-pQ\",\n        \"accept_data_loss\": false\n      }\n    }\n  ]\n}\n\n\n#数据丢失\npost /_cluster/reroute\n{\n\"commands\": [\n{\n\"allocate_empty_primary\": {\n\"index\": \"aabb_v2\",\n\"shard\": 0,\n\"node\": \"Ee6ubnnmT52LJchcw0P-pQ\",\n\"accept_data_loss\": true\n}\n}\n]\n}\n\n#数据不丢失\npost /_cluster/reroute\n{\n\"commands\" : [ {\n\"allocate_stale_primary\" : {\n\"index\" : \"aabb_v2\",\n\"shard\" :0,\n\"node\" : \"Ee6ubnnmT52LJchcw0P-pQ\",\n\"accept_data_loss\" : true\n}\n}]\n}\n\n\nPOST /_cluster/reroute?retry_failed=true\n\n\n手动迁移分片\nPOST /_cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"aabb_v1\",\n        \"shard\": 1,\n        \"from_node\": \"10.10.20.143\",\n        \"to_node\": \"10.10.20.153\"\n      }\n    }\n  ]\n}\n\n</code></pre></div><h2>记录慢日志，重启也生效</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>PUT /_settings\n{\n\"index.search.slowlog.level\": \"trace\",            \n\"index.search.slowlog.threshold.query.warn\": \"10s\",  \n\"index.search.slowlog.threshold.query.info\": \"5s\",  \n\"index.search.slowlog.threshold.query.debug\": \"2s\",  \n\"index.search.slowlog.threshold.query.trace\": \"500ms\"\n}\n</code></pre></div><h2>记录慢查询日志</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>curl -XPUT 'http://localhost:9200/_all/_settings?preserve_existing=true' -d '{\n  \"index.indexing.slowlog.threshold.index.debug\" : \"500ms\",\n  \"index.indexing.slowlog.threshold.index.info\" : \"2s\",\n  \"index.indexing.slowlog.threshold.index.warn\" : \"5s\",\n  \"index.search.slowlog.threshold.fetch.debug\" : \"500ms\",\n  \"index.search.slowlog.threshold.fetch.info\" : \"2s\",\n  \"index.search.slowlog.threshold.fetch.warn\" : \"5s\",\n  \"index.search.slowlog.threshold.query.debug\" : \"500ms\",\n  \"index.search.slowlog.threshold.query.info\" : \"2s\",\n  \"index.search.slowlog.threshold.query.warn\" : \"5s\"\n}'\n</code></pre></div><h2>批量按条件更新</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>POST pyspider/result/_update_by_query\n{\n  \"script\": {\n    \"inline\": \"ctx._source.result.company_list=0;\"\n  },\n  \"query\": {\n    \"term\": {\n      \"_id\": {\n        \"value\": \"qichacha:ecde53ee4b22383478536ee7d976046b\"\n      }\n    }\n  }\n}\n</code></pre></div><h2>搜索词分权重</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>post aabb/v9_news/_search\n{\n\"query\": {\n\"bool\": {\n\"must\": {\n\"multi_match\": {\n\"query\": \"温馨的客厅\",\n\"fields\": [\n\"title\"\n]\n}\n},\n\"should\": [\n{\n\"match\": {\n\"title\": {\n\"query\": \"客厅\",\n\"boost\": 4\n}\n}\n},\n{\n\"match\": {\n\"title\": {\n\"query\": \"温馨\",\n\"boost\": 2\n}\n}\n}\n]\n}\n},\"_source\":[\"title\",\"create_time\"]\n,\"size\": 50\n}\n</code></pre></div><h2>统一更改刷新时间</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>curl -XPUT 'http://10.10.20.165:9200/_all/_settings?preserve_existing=true' -d '{\n  \"index.refresh_interval\" : \"15s\"\n}'\n</code></pre></div><h2>优化性能</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>GET _nodes/hot_threads?pretty\n\n\nPUT /aabb/_settings\n{\n    \"index\":{\n        \"refresh_interval\":\"30s\",\n        \"translog\":{\n            \"flush_threshold_size\":\"2048m\",\n            \"sync_interval\":\"120s\",\n            \"durability\":\"async\"\n        },\n        \"merge\":{\n            \"policy.max_merge_at_once\":5,\n            \"policy.max_merge_at_once_explicit\":15,\n            \"policy.floor_segment\":\"1mb\",\n            \"scheduler.max_thread_count\":\"1\"\n        }\n    }\n}\n\n\nPUT /uc/_settings\n{\n    \"index\":{\n        \"refresh_interval\":\"-1\"\n        }\n}\n</code></pre></div><h2>索引复制数据</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>http://localhost:9200/_reindex\n{\n    \"source\":{\n        \"index\":\"old_index\"\n    },\n    \"dest\":{\n        \"index\":\"new_index\",\n        \"op_type\":\"create\"\n    }\n}\nhttp://localhost:9200/_reindex\n{\n    \"source\":{\n        \"index\":\"cut_word_data_v1\"\n    },\n    \"dest\":{\n        \"index\":\"cut_word_data_v2\",\n        \"op_type\":\"create\"\n    }\n}\ncurl -l -H \"Content-type: application/json\" -d '{\"source\":{\"index\":\"crm-address_v2\"},\"dest\":{\"index\":\"crm-address_v1\",\"op_type\":\"create\" }}'  http://localhost:9200/_reindex\n\n\ncurl -l -H \"Content-type: application/json\" -d '{\"source\":{\"index\":\"aabb_v1\"},\"dest\":{\"index\":\"aabb_v2\",\"op_type\":\"create\" }}'  http://localhost:9200/_reindex\n\n\ncurl -l -H \"Content-type: application/json\" -d '{\"source\":{\"index\":\"wap_anli_v2\"},\"dest\":{\"index\":\"wap_anli_v1\",\"op_type\":\"create\" }}'  http://localhost:9200/_reindex\n\n\ncurl -l -H \"Content-type: application/json\" -d '{\"source\":{\"remote\":{\"host\":\"http://10.10.20.33:9200\"},\"index\":\"kn2_es_v1\"},\"dest\":{\"index\":\"kn2_es_v1\",\"op_type\":\"create\"}}'  http://localhost:9200/_reindex\n\ncurl -l -H \"Content-type: application/json\" -d '{\"source\":{\"remote\":{\"host\":\"http://10.10.20.33:9200\"},\"index\":\"pyspider\"},\"dest\":{\"index\":\"pyspider_v1\",\"op_type\":\"create\"}}'  http://localhost:9200/_reindex\n\n\nhttp://localhost:9200/_reindex\n{\n    \"source\":{\n        \"index\":\"kn2_es_v1\"\n    },\n    \"dest\":{\n        \"index\":\"kn2_es_v2\",\n        \"op_type\":\"create\"\n    }\n}\n\n\n远程复制：\n\nPOST _reindex\n{\n    \"source\":{\n        \"remote\":{\n            \"host\":\"http://10.10.20.33:9200\"\n        },\n        \"index\":\"test1\"\n    },\n    \"dest\":{\n        \"index\":\"test2\",\n        \"op_type\":\"create\"\n    }\n}\n</code></pre></div><h2>暂时移除一个节点</h2>\n<div class=\"language-text\" data-ext=\"text\" data-title=\"text\"><pre class=\"language-text\"><code>\n下线：\nPUT _cluster/settings\n{\n\"transient\" : {\n\"cluster.routing.allocation.exclude._name\" : \"node-2\"\n}\n}\n注意 这个操作是transient集群重启后，这个设置会失效\n\n\n\n上线\nPUT _cluster/settings\n{\n\"transient\" : {\n\"cluster.routing.allocation.exclude._name\" : \"\"\n}\n}\n只要让_name匹配不到对用的node即可\n</code></pre></div><h2>搜索结果返回不一致问题</h2>\n<p>一、背景</p>\n<p>这周在使用Elasticsearch搜索的时候遇到一个，对于同一个搜索请求，会出现top50返回结果和排序不一致的问题。那么为什么会出现这样的问题？\n后来通过百度和google，发现这是因为Elastcisearch的分布式搜索特性导致。Elasticsearch在搜索时，会循环的选择主分片和其副本中的一个来计算和返回搜索结果，而由于主分片和副本中相关统计信息的不同，从而导致了同一个搜索串的评分的不一致，进而导致排序不一样。而造成这种主分片和副本统计信息不一致的具体原因，是因为文档删除时造成的，具体可以参考官方给出的解释：https://www.elastic.co/guide/en/elasticsearch/reference/current/consistent-scoring.html\n二、解决办法\n针对上述问题，Elasticsearch官方也给出了解决方案（https://www.elastic.co/guide/en/elasticsearch/guide/2.x/_search_options.html#_preference），即在搜索时设置preference特性。如下：\nSearchRequestBuilder builder = client.prepareSearch(offLin.index)\n.setTypes(offLin.type)\n.setQuery(queryBuilder)\n.setFetchSource(fetchFields, null)\n.setSize(limit)\n.setPreference(\"_primary_first\");\n那么preference可以取哪些值，每个值的含义是什么呢，可以参考下面解释：\n（1）randomizeacross shards：随机选择分片或其副本查询数据，es的默认方式。\n（2）_local：优先在本地节点上的分片查询数据然后再去其他节点上的分片查询，本地节点没有IO问题但有可能造成负载不均问题。\n（3）_primary：搜索只在主分片执行搜索请求，副本不参与搜索；性能会打折扣，达不到性能的水平扩展。\n（4）_primary_first：优先在主分片执行，如果主分片挂掉，会在副本执行请求。\n（5）_only_node:123 ：只在123这个节点执行搜索。\n（6）_prefer_node:123：搜索请求优先在节点123执行。\n（7）_shards:1,2：搜索只在分片2、3执行，可以与_primary参数一起使用如：_shards:2,3;_primary\n（8）随机字符串：指定一个随机字符串，可以保证同样的请求，被分配到同样的副本上面，从而保证同一请求结果的稳定性。我遇到的问题就可以使用这种方式，把搜索串的hash值作为随机字符串，这样可以保证同一个搜索条件的请求的返回结果和排序一致。</p>\n",
      "date_published": "2022-01-01T00:00:00.000Z",
      "date_modified": "2024-03-17T17:45:45.000Z",
      "authors": [],
      "tags": [
        "数据库"
      ]
    }
  ]
}
<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="https://blog.cizai.io/atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN">
  <id>https://blog.cizai.io/</id>
  <title>此在笔记</title>
  <subtitle>开源工具、效率方法、心理学探索的自我提升笔记 ，记录并输出一切能让自己提升的知识。</subtitle>
  <updated>2024-08-28T08:36:40.290Z</updated>
  <generator>@vuepress/plugin-feed</generator>
  <link rel="self" href="https://blog.cizai.io/atom.xml"/>
  <link rel="alternate" href="https://blog.cizai.io/"/>
  <category term="工具"/>
  <category term="站点收藏"/>
  <category term="数据库"/>
  <entry>
    <title type="text">nc端口测试</title>
    <id>https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/nc%E7%AB%AF%E5%8F%A3%E6%B5%8B%E8%AF%95.html</id>
    <link href="https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/nc%E7%AB%AF%E5%8F%A3%E6%B5%8B%E8%AF%95.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<p>nc (netcat) 是 Linux/Unix 下的一个网络工具，它可以用来测试和调试网络连接和端口。</p>
<h2>安装</h2>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ubuntu:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> apt-get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> netcat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">mac:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">brew</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> nc</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<p>nc (netcat) 是 Linux/Unix 下的一个网络工具，它可以用来测试和调试网络连接和端口。</p>
<h2>安装</h2>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ubuntu:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> apt-get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> netcat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">mac:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">brew</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> nc</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>测试 tcp</h2>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 监听 12345 端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -l</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 12345</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 连接到目标主机的 12345 端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -vz</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 127.0.0.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 12345</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">显示</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> succeeded!,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 表示连接成功。</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>测试 udp</h2>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 监听 12345 端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -lu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 12345</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 连接到目标主机的 12345 端口</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">nc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -vu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 127.0.0.1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 12345</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">如果立即结束，表示连接不成功，如果没有立即结束，不代表一定成功，可能有防火墙阻挡，需要在目标端使用tcpdump进行判断</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></content>
    <category term="工具"/>
    <published>2024-04-02T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">wireguard</title>
    <id>https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/wireguard.html</id>
    <link href="https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/wireguard.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>安装</h2>
<p>wireguard 一键安装脚本
https://github.com/angristan/wireguard-install</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>curl -O https://raw.githubusercontent.com/angristan/wireguard-install/master/wireguard-install.sh</span></span>
<span class="line"><span>chmod +x wireguard-install.sh</span></span>
<span class="line"><span>./wireguard-install.sh</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<h2>安装</h2>
<p>wireguard 一键安装脚本
https://github.com/angristan/wireguard-install</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>curl -O https://raw.githubusercontent.com/angristan/wireguard-install/master/wireguard-install.sh</span></span>
<span class="line"><span>chmod +x wireguard-install.sh</span></span>
<span class="line"><span>./wireguard-install.sh</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行可以添加更多用户</p>
<h2>配合v2ray使用</h2>
<p>https://www.40huo.cn/blog/wireguard-over-vless.html</p>
<p>https://github.com/XTLS/Xray-core/issues/1896</p>
]]></content>
    <category term="工具"/>
    <published>2024-06-26T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">流量捕获</title>
    <id>https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7.html</id>
    <link href="https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>mitmproxy</h2>
]]></summary>
    <content type="html"><![CDATA[
<h2>mitmproxy</h2>
]]></content>
    <category term="工具"/>
    <published>2024-06-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">反向代理应用frp</title>
    <id>https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/frp.html</id>
    <link href="https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/frp.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<p>拥有公网IP的情况下，可以使用frp来实现内网机器的端口映射和访问。</p>
<h2>安装</h2>
<p>linux</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/fatedier/frp/releases/download/v0.57.0/frp_0.57.0_linux_amd64.tar.gz</span></span>
<span class="line"><span>tar -zxvf frp_0.57.0_linux_amd64.tar.gz</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<p>拥有公网IP的情况下，可以使用frp来实现内网机器的端口映射和访问。</p>
<h2>安装</h2>
<p>linux</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/fatedier/frp/releases/download/v0.57.0/frp_0.57.0_linux_amd64.tar.gz</span></span>
<span class="line"><span>tar -zxvf frp_0.57.0_linux_amd64.tar.gz</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><p>mac</p>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/fatedier/frp/releases/download/v0.57.0/frp_0.57.0_darwin_arm64.tar.gz</span></span>
<span class="line"><span>tar -zxvf frp_0.57.0_darwin_arm64.tar.gz</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h2>通过tcp访问内网机器端口</h2>
<div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">公网服务器上编辑frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bindPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">内网服务器上编辑frpc.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">serverAddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "x.x.x.x"</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"> # 公网服务器的 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">serverPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[[proxies]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "ssh"</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "tcp"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localIP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "127.0.0.1"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 22</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">remotePort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 2222</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[[proxies]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "web"</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "tcp"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localIP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "127.0.0.1"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5500</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">remotePort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5555</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># localIP 和 localPort 配置为需要从公网访问的内网服务的地址和端口。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># remotePort 表示在 frp 服务端监听的端口，访问此端口的流量将被转发到本地服务的相应端口。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">启动</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 和</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frps</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frpc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc.toml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">使用以下命令通过</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> SSH</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 访问内网机器，假设用户名为</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> Port=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">2222</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> test@x.x.x.x</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">使用以下命令通过</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> Web</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 服务访问内网机器，假设服务运行在</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 5555</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 端口：</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">curl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> http://x.x.x.x:5555</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>通过自定义域名访问内网的 Web 服务</h2>
<div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">公网服务器上编辑frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bindPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">内网服务器上编辑frpc.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">serverAddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "x.x.x.x"</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"> # 公网服务器的 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">serverPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[[proxies]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "web"</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "http"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localIP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "127.0.0.1"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">localPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 80</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">customDomains</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"www.yourdomain.com"</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">启动</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 和</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frps</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frpc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc.toml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">将</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> www.yourdomain.com的域名</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 记录解析到服务器的</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> IP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 地址</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> x.x.x.x</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">访问</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> http://www.yourdomain.com</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 即可访问内网的</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> Web</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 服务</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>代理上网 （无法打开被强的网站）</h2>
<div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">公网服务器上编辑frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">bindPort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">内网服务器上编辑frpc.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">serverAddr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "x.x.x.x"</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"> # 公网服务器的 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">server_port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 7000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[[proxies]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "plugin_http_proxy"</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "tcp"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">remotePort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 6004</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[proxies.plugin]</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "http_proxy"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">httpUser</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "abc"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">httpPassword</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "abc"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[[proxies]]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "plugin_socks5"</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "tcp"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">remotePort</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 6005</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">[proxies.plugin]</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2">type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "socks5"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">username</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "abc"</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">password</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> "abc"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">启动</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 和</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frps</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frps.toml</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">./frpc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> frpc.toml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 设置代理</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> http_proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">://</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">abc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">abc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">@</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">6004</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> https_proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">$http_proxy</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> all_proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">socks5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">://</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">abc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">abc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">@</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75">6005</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75"> no_proxy</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">"localhost,127.0.0.1,x.x.x.x"</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> https://www.baidu.com</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 可以代理访问</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> https://www.google.com</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 无法打开被强的网站，因为没有伪装加密</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></content>
    <category term="工具"/>
    <published>2024-04-02T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">内网穿透</title>
    <id>https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html</id>
    <link href="https://blog.cizai.io/%E7%BC%96%E7%A8%8B/%E5%B7%A5%E5%85%B7/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>serveo</h2>
<p>ssh -R 80:localhost:3000 serveo.net</p>
<h2>ngrok</h2>
<h3>启动时需要验证</h3>
<p>ngrok http 3000</p>
<h2>localtunnel</h2>
<h3>访问时需要验证</h3>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">快速开始</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">npx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> localtunnel</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --subdomain</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> cizai</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">全局安装</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">npm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -g</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> localtunnel</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">自定义个性前缀</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --subdomain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">个性前</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">缀&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">--port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">要映射的端</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">口&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 获取访问密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -q</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -O</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> https://loca.lt/mytunnelpassword</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<h2>serveo</h2>
<p>ssh -R 80:localhost:3000 serveo.net</p>
<h2>ngrok</h2>
<h3>启动时需要验证</h3>
<p>ngrok http 3000</p>
<h2>localtunnel</h2>
<h3>访问时需要验证</h3>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">快速开始</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">npx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> localtunnel</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --subdomain</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> cizai</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">全局安装</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">npm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> install</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -g</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> localtunnel</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> 3000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">自定义个性前缀</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">lt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --subdomain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">个性前</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">缀&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66">--port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">要映射的端</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">口&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic"># 获取访问密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">wget</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -q</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -O</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> https://loca.lt/mytunnelpassword</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>cloudflare tunnel</h2>
<div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">登录到cloudflare.com，点击Zero</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> Trust,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">选择Network</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">Tunnels，点击Create</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> a</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> Tunnel，Cloudflared和WARP选择Cloudflared，填入一个tunnel名称</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">点击保存后，选择</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> 方式部署，在本地执行以下命令</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> cloudflared</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --restart=unless-stopped</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> cloudflare/cloudflared:latest</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> tunnel</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --no-autoupdate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66"> --token</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379">toke</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF">n&gt; </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF">查看Connectors页面是否有刚才创建的Tunnel，接着点击下一步，填入子域名和要映射的本地端口，点击创建Tunnel，等待几分钟后，就可以通过子域名访问本地</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>vscode 端口转发</h2>
<h2>WireGuard</h2>
<h2>frp</h2>
<p>https://github.com/fatedier/frp</p>
<h2>免费域名</h2>
<p>https://iyideng.net/welfare/best-free-domain-name-registration-platform.html</p>
]]></content>
    <category term="工具"/>
    <published>2024-04-02T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">关于本站</title>
    <id>https://blog.cizai.io/%E5%85%B3%E4%BA%8E%E6%9C%AC%E7%AB%99.html</id>
    <link href="https://blog.cizai.io/%E5%85%B3%E4%BA%8E%E6%9C%AC%E7%AB%99.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<p>一个全栈开发者，从事大数据开发。</p>
<p>本站桌面端安装包，支持windows，linux，mac。<a href="https://file.cizai.io/wooapp.json" target="_blank" rel="noopener noreferrer">下载地址</a></p>
<div id="dynamic-content">
  <p>Loading...</p>
</div>
]]></summary>
    <content type="html"><![CDATA[
<p>一个全栈开发者，从事大数据开发。</p>
<p>本站桌面端安装包，支持windows，linux，mac。<a href="https://file.cizai.io/wooapp.json" target="_blank" rel="noopener noreferrer">下载地址</a></p>
<div id="dynamic-content">
  <p>Loading...</p>
</div>
]]></content>
    <published>2024-03-17T17:45:45.000Z</published>
  </entry>
  <entry>
    <title type="text">站点收藏</title>
    <id>https://blog.cizai.io/%E7%AB%99%E7%82%B9%E6%94%B6%E8%97%8F.html</id>
    <link href="https://blog.cizai.io/%E7%AB%99%E7%82%B9%E6%94%B6%E8%97%8F.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>白噪音</h2>
<table>
<thead>
<tr>
<th style="text-align:left">简介</th>
<th style="text-align:left">网址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">下雨声</td>
<td style="text-align:left">http://www.rainymood.com/</td>
</tr>
<tr>
<td style="text-align:left">下雨声</td>
<td style="text-align:left">http://mostlyrain.com/</td>
</tr>
<tr>
<td style="text-align:left">下雨声</td>
<td style="text-align:left">https://www.calm.com/</td>
</tr>
</tbody>
</table>]]></summary>
    <content type="html"><![CDATA[
<h2>白噪音</h2>
<p>| 简介   | 网址                      |
| :</p>
]]></content>
    <category term="站点收藏"/>
    <published>2022-01-01T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Impala</title>
    <id>https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/Impala.html</id>
    <link href="https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/Impala.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>Impala时间戳分组</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>select   </span></span>
<span class="line"><span>from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') as sdate,</span></span>
<span class="line"><span>count(1),</span></span>
<span class="line"><span>count(if(second_id is null,1,null))</span></span>
<span class="line"><span>from users </span></span>
<span class="line"><span>-- 2023-06-14 00:00:00</span></span>
<span class="line"><span>where siyu_add_time &gt; 1686672000000</span></span>
<span class="line"><span>group by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd')</span></span>
<span class="line"><span>order by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') desc</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<h2>Impala时间戳分组</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>select   </span></span>
<span class="line"><span>from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') as sdate,</span></span>
<span class="line"><span>count(1),</span></span>
<span class="line"><span>count(if(second_id is null,1,null))</span></span>
<span class="line"><span>from users </span></span>
<span class="line"><span>-- 2023-06-14 00:00:00</span></span>
<span class="line"><span>where siyu_add_time &gt; 1686672000000</span></span>
<span class="line"><span>group by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd')</span></span>
<span class="line"><span>order by from_unixtime(cast(siyu_add_time/1000 as int) , 'yyyy-MM-dd') desc</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></content>
    <category term="数据库"/>
    <published>2022-01-01T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">clickhouse</title>
    <id>https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/clickhouse.html</id>
    <link href="https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/clickhouse.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>clickhouse 常用命令</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>更新数据</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update item_no='' where item_no is null;</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update store_shop_code='' where store_shop_code is null;</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update unify_goods_code='' where unify_goods_code is null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>重命名表</span></span>
<span class="line"><span>RENAME TABLE table_A TO table_A_bak, table_B TO table_B_bak;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看所有表</span></span>
<span class="line"><span>select *</span></span>
<span class="line"><span>FROM system.tables t WHERE database ='ads' AND engine &lt;&gt;'Distributed' ORDER by total_rows DESC </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>select *</span></span>
<span class="line"><span>FROM system.tables t WHERE database ='ads'</span></span>
<span class="line"><span>AND engine &lt;&gt;'Distributed'</span></span>
<span class="line"><span>and name not like '%del%'</span></span>
<span class="line"><span>and name not like '%20%'</span></span>
<span class="line"><span>ORDER by total_rows DESC</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>自动清理query_log，query_thread_log，trace_log</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.query_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.query_thread_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.trace_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>立即清理</span></span>
<span class="line"><span>alter table system.query_thread_log_0 drop partition '202105'</span></span>
<span class="line"><span>分区名可以用下语句查询</span></span>
<span class="line"><span>select * from system.parts p where table = '表名'</span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看parts  </span></span>
<span class="line"><span>select * from system.parts  where table = 'abs_activity_item_info_day_replica'</span></span>
<span class="line"><span>select * from system.parts where active = 0</span></span>
<span class="line"><span>当前慢查询</span></span>
<span class="line"><span>SELECT * FROM system.processes limit 100</span></span>
<span class="line"><span></span></span>
<span class="line"><span>耗时大于60秒</span></span>
<span class="line"><span>kill query where elapsed &gt;= 60</span></span>
<span class="line"><span></span></span>
<span class="line"><span>clickhouse不能创建等执行操作时（每个节点都要执行）</span></span>
<span class="line"><span>select * from system.mutations where is_done = 0;</span></span>
<span class="line"><span>kill mutation ON CLUSTER ck_cluster1 </span></span>
<span class="line"><span> where database='ads' and table='ads_jd_erp_sale_outstock_replica' </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>进入zk清理任务</span></span>
<span class="line"><span>deleteall /clickhouse/distributed_ddl/query-0000011932</span></span>
<span class="line"><span>查询阻塞的任务</span></span>
<span class="line"><span>select * from system.distributed_ddl_queue where status != 'Finished'</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看表大小</span></span>
<span class="line"><span>SELECT</span></span>
<span class="line"><span>    table AS `表名`,</span></span>
<span class="line"><span>    sum(rows) AS `总行数`,</span></span>
<span class="line"><span>    formatReadableSize(sum(data_uncompressed_bytes)) AS `原始大小`,</span></span>
<span class="line"><span>    formatReadableSize(sum(data_compressed_bytes)) AS `压缩大小`,</span></span>
<span class="line"><span>    round((sum(data_compressed_bytes) / sum(data_uncompressed_bytes)) * 100, 0) AS `压缩率`</span></span>
<span class="line"><span>FROM system.parts</span></span>
<span class="line"><span>GROUP BY table</span></span>
<span class="line"><span>order by sum(data_compressed_bytes) desc</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>修改字段名</span></span>
<span class="line"><span>ALTER TABLE visits RENAME COLUMN webBrowser TO browser</span></span>
<span class="line"><span>分布式集群下用分布式DDL修改字段名</span></span>
<span class="line"><span>ALTER TABLE visits on cluster shipin_cluster RENAME COLUMN webBrowser TO browser</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>新增字段</span></span>
<span class="line"><span> alter table ads_itemprice_sales_section_replica ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)</span></span>
<span class="line"><span> alter table ads_itemprice_sales_section ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<h2>clickhouse 常用命令</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>更新数据</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update item_no='' where item_no is null;</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update store_shop_code='' where store_shop_code is null;</span></span>
<span class="line"><span>ALTER table ads_sales_item_shop_di_replica ON CLUSTER ck_cluster1 update unify_goods_code='' where unify_goods_code is null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>重命名表</span></span>
<span class="line"><span>RENAME TABLE table_A TO table_A_bak, table_B TO table_B_bak;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看所有表</span></span>
<span class="line"><span>select *</span></span>
<span class="line"><span>FROM system.tables t WHERE database ='ads' AND engine &lt;&gt;'Distributed' ORDER by total_rows DESC </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>select *</span></span>
<span class="line"><span>FROM system.tables t WHERE database ='ads'</span></span>
<span class="line"><span>AND engine &lt;&gt;'Distributed'</span></span>
<span class="line"><span>and name not like '%del%'</span></span>
<span class="line"><span>and name not like '%20%'</span></span>
<span class="line"><span>ORDER by total_rows DESC</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>自动清理query_log，query_thread_log，trace_log</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.query_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.query_thread_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ALTER TABLE system.trace_log on cluster ck_cluster1 MODIFY TTL event_date + INTERVAL 15 DAY</span></span>
<span class="line"><span></span></span>
<span class="line"><span>立即清理</span></span>
<span class="line"><span>alter table system.query_thread_log_0 drop partition '202105'</span></span>
<span class="line"><span>分区名可以用下语句查询</span></span>
<span class="line"><span>select * from system.parts p where table = '表名'</span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看parts  </span></span>
<span class="line"><span>select * from system.parts  where table = 'abs_activity_item_info_day_replica'</span></span>
<span class="line"><span>select * from system.parts where active = 0</span></span>
<span class="line"><span>当前慢查询</span></span>
<span class="line"><span>SELECT * FROM system.processes limit 100</span></span>
<span class="line"><span></span></span>
<span class="line"><span>耗时大于60秒</span></span>
<span class="line"><span>kill query where elapsed &gt;= 60</span></span>
<span class="line"><span></span></span>
<span class="line"><span>clickhouse不能创建等执行操作时（每个节点都要执行）</span></span>
<span class="line"><span>select * from system.mutations where is_done = 0;</span></span>
<span class="line"><span>kill mutation ON CLUSTER ck_cluster1 </span></span>
<span class="line"><span> where database='ads' and table='ads_jd_erp_sale_outstock_replica' </span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>进入zk清理任务</span></span>
<span class="line"><span>deleteall /clickhouse/distributed_ddl/query-0000011932</span></span>
<span class="line"><span>查询阻塞的任务</span></span>
<span class="line"><span>select * from system.distributed_ddl_queue where status != 'Finished'</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>查看表大小</span></span>
<span class="line"><span>SELECT</span></span>
<span class="line"><span>    table AS `表名`,</span></span>
<span class="line"><span>    sum(rows) AS `总行数`,</span></span>
<span class="line"><span>    formatReadableSize(sum(data_uncompressed_bytes)) AS `原始大小`,</span></span>
<span class="line"><span>    formatReadableSize(sum(data_compressed_bytes)) AS `压缩大小`,</span></span>
<span class="line"><span>    round((sum(data_compressed_bytes) / sum(data_uncompressed_bytes)) * 100, 0) AS `压缩率`</span></span>
<span class="line"><span>FROM system.parts</span></span>
<span class="line"><span>GROUP BY table</span></span>
<span class="line"><span>order by sum(data_compressed_bytes) desc</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>修改字段名</span></span>
<span class="line"><span>ALTER TABLE visits RENAME COLUMN webBrowser TO browser</span></span>
<span class="line"><span>分布式集群下用分布式DDL修改字段名</span></span>
<span class="line"><span>ALTER TABLE visits on cluster shipin_cluster RENAME COLUMN webBrowser TO browser</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>新增字段</span></span>
<span class="line"><span> alter table ads_itemprice_sales_section_replica ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)</span></span>
<span class="line"><span> alter table ads_itemprice_sales_section ON CLUSTER ck_cluster1 add column sort_mark Nullable(int)</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>clickhouse表引擎</h2>
<p>| 系列        | 引擎                         | 特点                                                                                                                                                                                                                                    | 场景                                                                                     |
|</p>
]]></content>
    <category term="数据库"/>
    <published>2022-01-01T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">elasticsearch</title>
    <id>https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch.html</id>
    <link href="https://blog.cizai.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch.html"/>
    <updated>2024-07-24T07:22:17.000Z</updated>
    <summary type="html"><![CDATA[
<h2>查看集群状态，修复</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>GET _cluster/allocation/explain?pretty</span></span>
<span class="line"><span></span></span>
<span class="line"><span>GET /_cluster/allocation/explain</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get /_cluster/settings</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.allocation.enable": "none"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>#分片配置</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.allocation.enable": "all"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#分片重新均衡分配</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.rebalance.enable": "all"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 设置副本数量</span></span>
<span class="line"><span>PUT /aabb/_settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"number_of_replicas" : 2</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get _cluster/health?level=indices</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>GET _cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl http://localhost:9200/_cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get _cat/master</span></span>
<span class="line"><span></span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "commands": [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      "allocate_empty_primary": {</span></span>
<span class="line"><span>        "index": "wap_yonghu_v1",</span></span>
<span class="line"><span>        "shard": 2,</span></span>
<span class="line"><span>        "node": "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>        "accept_data_loss": false</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#数据丢失</span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"commands": [</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"allocate_empty_primary": {</span></span>
<span class="line"><span>"index": "aabb_v2",</span></span>
<span class="line"><span>"shard": 0,</span></span>
<span class="line"><span>"node": "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>"accept_data_loss": true</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#数据不丢失</span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"commands" : [ {</span></span>
<span class="line"><span>"allocate_stale_primary" : {</span></span>
<span class="line"><span>"index" : "aabb_v2",</span></span>
<span class="line"><span>"shard" :0,</span></span>
<span class="line"><span>"node" : "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>"accept_data_loss" : true</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /_cluster/reroute?retry_failed=true</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>手动迁移分片</span></span>
<span class="line"><span>POST /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "commands": [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      "move": {</span></span>
<span class="line"><span>        "index": "aabb_v1",</span></span>
<span class="line"><span>        "shard": 1,</span></span>
<span class="line"><span>        "from_node": "10.10.20.143",</span></span>
<span class="line"><span>        "to_node": "10.10.20.153"</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>]]></summary>
    <content type="html"><![CDATA[
<h2>查看集群状态，修复</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>GET _cluster/allocation/explain?pretty</span></span>
<span class="line"><span></span></span>
<span class="line"><span>GET /_cluster/allocation/explain</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get /_cluster/settings</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.allocation.enable": "none"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>#分片配置</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.allocation.enable": "all"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#分片重新均衡分配</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /_cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "transient": {</span></span>
<span class="line"><span>    "cluster.routing.rebalance.enable": "all"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 设置副本数量</span></span>
<span class="line"><span>PUT /aabb/_settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"number_of_replicas" : 2</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get _cluster/health?level=indices</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>GET _cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl http://localhost:9200/_cat/nodes?v&amp;h=ip,heap.current,heap.percent,heap.max,ram.max,disk.avail,node.role,m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>get _cat/master</span></span>
<span class="line"><span></span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "commands": [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      "allocate_empty_primary": {</span></span>
<span class="line"><span>        "index": "wap_yonghu_v1",</span></span>
<span class="line"><span>        "shard": 2,</span></span>
<span class="line"><span>        "node": "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>        "accept_data_loss": false</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#数据丢失</span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"commands": [</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"allocate_empty_primary": {</span></span>
<span class="line"><span>"index": "aabb_v2",</span></span>
<span class="line"><span>"shard": 0,</span></span>
<span class="line"><span>"node": "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>"accept_data_loss": true</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#数据不丢失</span></span>
<span class="line"><span>post /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"commands" : [ {</span></span>
<span class="line"><span>"allocate_stale_primary" : {</span></span>
<span class="line"><span>"index" : "aabb_v2",</span></span>
<span class="line"><span>"shard" :0,</span></span>
<span class="line"><span>"node" : "Ee6ubnnmT52LJchcw0P-pQ",</span></span>
<span class="line"><span>"accept_data_loss" : true</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST /_cluster/reroute?retry_failed=true</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>手动迁移分片</span></span>
<span class="line"><span>POST /_cluster/reroute</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "commands": [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      "move": {</span></span>
<span class="line"><span>        "index": "aabb_v1",</span></span>
<span class="line"><span>        "shard": 1,</span></span>
<span class="line"><span>        "from_node": "10.10.20.143",</span></span>
<span class="line"><span>        "to_node": "10.10.20.153"</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  ]</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>记录慢日志，重启也生效</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>PUT /_settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"index.search.slowlog.level": "trace",            </span></span>
<span class="line"><span>"index.search.slowlog.threshold.query.warn": "10s",  </span></span>
<span class="line"><span>"index.search.slowlog.threshold.query.info": "5s",  </span></span>
<span class="line"><span>"index.search.slowlog.threshold.query.debug": "2s",  </span></span>
<span class="line"><span>"index.search.slowlog.threshold.query.trace": "500ms"</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>记录慢查询日志</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>curl -XPUT 'http://localhost:9200/_all/_settings?preserve_existing=true' -d '{</span></span>
<span class="line"><span>  "index.indexing.slowlog.threshold.index.debug" : "500ms",</span></span>
<span class="line"><span>  "index.indexing.slowlog.threshold.index.info" : "2s",</span></span>
<span class="line"><span>  "index.indexing.slowlog.threshold.index.warn" : "5s",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.fetch.debug" : "500ms",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.fetch.info" : "2s",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.fetch.warn" : "5s",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.query.debug" : "500ms",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.query.info" : "2s",</span></span>
<span class="line"><span>  "index.search.slowlog.threshold.query.warn" : "5s"</span></span>
<span class="line"><span>}'</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>批量按条件更新</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>POST pyspider/result/_update_by_query</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  "script": {</span></span>
<span class="line"><span>    "inline": "ctx._source.result.company_list=0;"</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  "query": {</span></span>
<span class="line"><span>    "term": {</span></span>
<span class="line"><span>      "_id": {</span></span>
<span class="line"><span>        "value": "qichacha:ecde53ee4b22383478536ee7d976046b"</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>搜索词分权重</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>post aabb/v9_news/_search</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"query": {</span></span>
<span class="line"><span>"bool": {</span></span>
<span class="line"><span>"must": {</span></span>
<span class="line"><span>"multi_match": {</span></span>
<span class="line"><span>"query": "温馨的客厅",</span></span>
<span class="line"><span>"fields": [</span></span>
<span class="line"><span>"title"</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>},</span></span>
<span class="line"><span>"should": [</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"match": {</span></span>
<span class="line"><span>"title": {</span></span>
<span class="line"><span>"query": "客厅",</span></span>
<span class="line"><span>"boost": 4</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>},</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"match": {</span></span>
<span class="line"><span>"title": {</span></span>
<span class="line"><span>"query": "温馨",</span></span>
<span class="line"><span>"boost": 2</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>},"_source":["title","create_time"]</span></span>
<span class="line"><span>,"size": 50</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>统一更改刷新时间</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>curl -XPUT 'http://10.10.20.165:9200/_all/_settings?preserve_existing=true' -d '{</span></span>
<span class="line"><span>  "index.refresh_interval" : "15s"</span></span>
<span class="line"><span>}'</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>优化性能</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>GET _nodes/hot_threads?pretty</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /aabb/_settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "index":{</span></span>
<span class="line"><span>        "refresh_interval":"30s",</span></span>
<span class="line"><span>        "translog":{</span></span>
<span class="line"><span>            "flush_threshold_size":"2048m",</span></span>
<span class="line"><span>            "sync_interval":"120s",</span></span>
<span class="line"><span>            "durability":"async"</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        "merge":{</span></span>
<span class="line"><span>            "policy.max_merge_at_once":5,</span></span>
<span class="line"><span>            "policy.max_merge_at_once_explicit":15,</span></span>
<span class="line"><span>            "policy.floor_segment":"1mb",</span></span>
<span class="line"><span>            "scheduler.max_thread_count":"1"</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /uc/_settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "index":{</span></span>
<span class="line"><span>        "refresh_interval":"-1"</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>索引复制数据</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>http://localhost:9200/_reindex</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "source":{</span></span>
<span class="line"><span>        "index":"old_index"</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    "dest":{</span></span>
<span class="line"><span>        "index":"new_index",</span></span>
<span class="line"><span>        "op_type":"create"</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>http://localhost:9200/_reindex</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "source":{</span></span>
<span class="line"><span>        "index":"cut_word_data_v1"</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    "dest":{</span></span>
<span class="line"><span>        "index":"cut_word_data_v2",</span></span>
<span class="line"><span>        "op_type":"create"</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>curl -l -H "Content-type: application/json" -d '{"source":{"index":"crm-address_v2"},"dest":{"index":"crm-address_v1","op_type":"create" }}'  http://localhost:9200/_reindex</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl -l -H "Content-type: application/json" -d '{"source":{"index":"aabb_v1"},"dest":{"index":"aabb_v2","op_type":"create" }}'  http://localhost:9200/_reindex</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl -l -H "Content-type: application/json" -d '{"source":{"index":"wap_anli_v2"},"dest":{"index":"wap_anli_v1","op_type":"create" }}'  http://localhost:9200/_reindex</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl -l -H "Content-type: application/json" -d '{"source":{"remote":{"host":"http://10.10.20.33:9200"},"index":"kn2_es_v1"},"dest":{"index":"kn2_es_v1","op_type":"create"}}'  http://localhost:9200/_reindex</span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl -l -H "Content-type: application/json" -d '{"source":{"remote":{"host":"http://10.10.20.33:9200"},"index":"pyspider"},"dest":{"index":"pyspider_v1","op_type":"create"}}'  http://localhost:9200/_reindex</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>http://localhost:9200/_reindex</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "source":{</span></span>
<span class="line"><span>        "index":"kn2_es_v1"</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    "dest":{</span></span>
<span class="line"><span>        "index":"kn2_es_v2",</span></span>
<span class="line"><span>        "op_type":"create"</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>远程复制：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>POST _reindex</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    "source":{</span></span>
<span class="line"><span>        "remote":{</span></span>
<span class="line"><span>            "host":"http://10.10.20.33:9200"</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        "index":"test1"</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    "dest":{</span></span>
<span class="line"><span>        "index":"test2",</span></span>
<span class="line"><span>        "op_type":"create"</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>暂时移除一个节点</h2>
<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span></span></span>
<span class="line"><span>下线：</span></span>
<span class="line"><span>PUT _cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"transient" : {</span></span>
<span class="line"><span>"cluster.routing.allocation.exclude._name" : "node-2"</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>注意 这个操作是transient集群重启后，这个设置会失效</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>上线</span></span>
<span class="line"><span>PUT _cluster/settings</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>"transient" : {</span></span>
<span class="line"><span>"cluster.routing.allocation.exclude._name" : ""</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>只要让_name匹配不到对用的node即可</span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2>搜索结果返回不一致问题</h2>
<p>一、背景</p>
<p>这周在使用Elasticsearch搜索的时候遇到一个，对于同一个搜索请求，会出现top50返回结果和排序不一致的问题。那么为什么会出现这样的问题？
后来通过百度和google，发现这是因为Elastcisearch的分布式搜索特性导致。Elasticsearch在搜索时，会循环的选择主分片和其副本中的一个来计算和返回搜索结果，而由于主分片和副本中相关统计信息的不同，从而导致了同一个搜索串的评分的不一致，进而导致排序不一样。而造成这种主分片和副本统计信息不一致的具体原因，是因为文档删除时造成的，具体可以参考官方给出的解释：https://www.elastic.co/guide/en/elasticsearch/reference/current/consistent-scoring.html
二、解决办法
针对上述问题，Elasticsearch官方也给出了解决方案（https://www.elastic.co/guide/en/elasticsearch/guide/2.x/_search_options.html#_preference），即在搜索时设置preference特性。如下：
SearchRequestBuilder builder = client.prepareSearch(offLin.index)
.setTypes(offLin.type)
.setQuery(queryBuilder)
.setFetchSource(fetchFields, null)
.setSize(limit)
.setPreference("_primary_first");
那么preference可以取哪些值，每个值的含义是什么呢，可以参考下面解释：
（1）randomizeacross shards：随机选择分片或其副本查询数据，es的默认方式。
（2）_local：优先在本地节点上的分片查询数据然后再去其他节点上的分片查询，本地节点没有IO问题但有可能造成负载不均问题。
（3）_primary：搜索只在主分片执行搜索请求，副本不参与搜索；性能会打折扣，达不到性能的水平扩展。
（4）_primary_first：优先在主分片执行，如果主分片挂掉，会在副本执行请求。
（5）_only_node:123 ：只在123这个节点执行搜索。
（6）_prefer_node:123：搜索请求优先在节点123执行。
（7）_shards:1,2：搜索只在分片2、3执行，可以与_primary参数一起使用如：_shards:2,3;_primary
（8）随机字符串：指定一个随机字符串，可以保证同样的请求，被分配到同样的副本上面，从而保证同一请求结果的稳定性。我遇到的问题就可以使用这种方式，把搜索串的hash值作为随机字符串，这样可以保证同一个搜索条件的请求的返回结果和排序一致。</p>
]]></content>
    <category term="数据库"/>
    <published>2022-01-01T00:00:00.000Z</published>
  </entry>
</feed>